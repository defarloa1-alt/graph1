# Query Executor Agent - Quickstart Guide

## Overview
The Query Executor Agent is a ChatGPT-powered Neo4j query agent that can:
- Execute natural language queries against the Chrystallum knowledge graph
- Discover Neo4j schema dynamically
- Generate and execute Cypher queries
- Submit claims to the knowledge graph with automatic promotion

## Prerequisites

### 1. Environment Setup
Ensure you have Python 3.8+ and the required packages installed:

```bash
cd scripts/agents
pip install -r requirements.txt
```

Required package versions:
- neo4j>=5.0.0
- openai>=0.27.0

### 2. Environment Variables
Set these before running the agent:

**On Windows PowerShell:**
```powershell
$env:NEO4J_PASSWORD = "your_neo4j_password"
$env:OPENAI_API_KEY = "your_openai_api_key"
$env:NEO4J_URI = "bolt://localhost:7687"  # or neo4j+s://your_aura_instance
$env:NEO4J_USERNAME = "neo4j"
$env:NEO4J_DATABASE = "neo4j"
```

**On Windows Command Prompt:**
```cmd
set NEO4J_PASSWORD=your_neo4j_password
set OPENAI_API_KEY=your_openai_api_key
set NEO4J_URI=bolt://localhost:7687
set NEO4J_USERNAME=neo4j
set NEO4J_DATABASE=neo4j
```

**On macOS/Linux:**
```bash
export NEO4J_PASSWORD="your_neo4j_password"
export OPENAI_API_KEY="your_openai_api_key"
export NEO4J_URI="bolt://localhost:7687"
export NEO4J_USERNAME="neo4j"
export NEO4J_DATABASE="neo4j"
```

## Usage Modes

### Mode 1: Run Predefined Query Tests
Tests the agent's ability to discover schema and generate Cypher queries:

```bash
python query_executor_agent_test.py test
```

**Expected Output:**
- Schema discovery (labels and relationship types)
- 3-5 predefined queries executed
- Results displayed in formatted output
- Sample queries: "Show all Events", "Find Romans", etc.

**Success Criteria:**
- No connection errors
- Valid Cypher generated by ChatGPT
- Query results returned
- No database errors

---

### Mode 2: Run Claim Submission Tests
Tests the full claim ingestion and promotion workflow:

```bash
python query_executor_agent_test.py claims
```

**What It Tests:**
1. **Low Confidence Claim (0.75):**
   - Creates claim node
   - Links to source and target entities
   - Creates intermediary nodes (Context, Analysis, Facet)
   - Status: "created" (not promoted)

2. **High Confidence Claim (0.95):**
   - Creates claim node
   - Attempts promotion (if confidence >= 0.90)
   - Creates canonical relationship if promoted
   - Creates SUPPORTED_BY traceability edges
   - Status: "promoted" (if prerequisites met)

**Expected Output:**
```
[Test 1] Low confidence claim (proposed)
status: created
claim_id: claim_evt_battle_of_actium_q193304_occurred_during_prd_roman_republic_q17167
cipher: <64-char SHA256 hash>
promoted: false

[Test 2] High confidence claim (should promote if prerequisites met)
status: promoted
claim_id: claim_evt_battle_of_actium_q193304_located_in_plc_actium_q41747
cipher: <64-char SHA256 hash>
promoted: true
```

**Success Criteria:**
- No exceptions
- Claim nodes created in Neo4j
- Low confidence: promoted=false
- High confidence: promoted=true (if context nodes exist)
- SUPPORTED_BY relationships visible in graph

---

### Mode 3: Interactive Query Mode
Manual testing with a REPL interface:

```bash
python query_executor_agent_test.py interactive
```

**Interactive Commands:**
```
> Show all humans in the graph
> Find events in 31 BCE
> What subjects are related to Q17167?
> exit
```

Type natural language queries. Agent will:
1. Discover schema if not already cached
2. Display current schema
3. Generate Cypher for your query
4. Execute and display results
5. Loop until "exit"

---

### Mode 4: Single Query Mode
Execute a single query without entering REPL:

```bash
python query_executor_agent_test.py "Show all Events in 31 BCE"
```

The agent will:
1. Generate Cypher for your query
2. Execute it
3. Display results
4. Exit

---

### Mode 5: Default Mode
If no arguments provided, runs basic tests:

```bash
python query_executor_agent_test.py
```

Equivalent to `python query_executor_agent_test.py test`

## Claim Submission Programmatically

### In Python Code:

```python
from query_executor_agent_test import ChromatogramQueryExecutor

# Initialize agent
executor = ChromatogramQueryExecutor()

# Submit a claim
result = executor.submit_claim(
    entity_id="evt_battle_of_actium_q193304",
    relationship_type="OCCURRED_DURING",
    target_id="prd_roman_republic_q17167",
    confidence=0.95,
    label="Battle of Actium in Roman Republic",
    subject_qid="Q17167",
    reasoning_notes="Agent observed historical sources confirming event timing",
    facet="military"
)

# Process result
if result["status"] == "promoted":
    print(f"Claim promoted! ID: {result['claim_id']}")
elif result["status"] == "created":
    print(f"Claim created (not promoted). ID: {result['claim_id']}")
else:
    print(f"Error: {result['error']}")

executor.close()
```

### Return Value:
```python
{
    "status": "created" | "promoted" | "error",
    "claim_id": "claim_<entity>_<relationship>_<target>",
    "cipher": "<SHA256 hash>",
    "promoted": True | False,
    "error": None | error_message
}
```

## Architecture

### Agent Components:
1. **Schema Discovery** - CALL db.labels() and CALL db.relationshipTypes()
2. **Query Generation** - ChatGPT translates NLQ to Cypher
3. **Query Execution** - Neo4j driver executes Cypher
4. **Claim Submission** - ClaimIngestionPipeline validates, creates, and promotes

### Claim Flow:
```
submit_claim()
    ↓
ClaimIngestionPipeline.ingest_claim()
    ↓
Validate entity/field existence
    ↓
Generate deterministic claim_id (MD5-based)
    ↓
Calculate SHA256 cipher for integrity
    ↓
Create Claim node with properties
    ├── Create RetrievalContext + USED_CONTEXT link
    ├── Create AnalysisRun + HAS_ANALYSIS_RUN link
    ├── Create FacetAssessment + HAS_FACET_ASSESSMENT link
    └── Link claim to source + target entities (ASSERTS)
    ↓
if confidence >= 0.90 and prerequisites met:
    ├── Update claim status to 'validated'
    ├── Create canonical relationship (entity -[type]-> target)
    ├── Link both entities back to claim (SUPPORTED_BY)
    └── Set promoted=true
    ↓
Return result dict
```

## Troubleshooting

### "NEO4J_PASSWORD not set"
**Solution:** Set the environment variable before running:
```powershell
$env:NEO4J_PASSWORD = "your_password"
```

### "OPENAI_API_KEY not set"
**Solution:** Set the environment variable before running:
```powershell
$env:OPENAI_API_KEY = "your_api_key"
```

### "Failed to authenticate to server"
**Possible Causes:**
- Incorrect password
- Neo4j service not running
- Wrong URI (check NEO4J_URI environment variable)

**Solution:**
```powershell
# Test connection manually
python -c "
from neo4j import GraphDatabase
driver = GraphDatabase.driver('bolt://localhost:7687', auth=('neo4j', 'your_password'))
with driver.session() as session:
    result = session.run('RETURN 1')
    print('Connection successful')
driver.close()
"
```

### "Failed to establish a connection"
**Causes:**
- Neo4j not running
- Wrong host/port in NEO4J_URI
- Network connectivity issue

**Solution:**
```powershell
# Check if Neo4j is running (standalone)
netstat -an | findstr 7687

# Or check Neo4j desktop app is running
# Try connecting to Aura instance if local doesn't work
$env:NEO4J_URI = "neo4j+s://your_aura_instance"
```

### ChatGPT returns invalid Cypher
**Causes:**
- API rate limit hit
- Invalid schema labels in graph
- Complex query that doesn't map to graph structure

**Solution:**
- Check ChatGPT output in console
- Simplify query
- Review schema output from agent
- Check Neo4j logs for syntax errors

### Claims not promoting
**Possible Causes:**
- Confidence < 0.90
- Missing RetrievalContext node
- Missing AnalysisRun node
- Target entity doesn't exist

**Solution:**
- Check test_claim_submission() output for error details
- Verify target entities exist: `MATCH (n) WHERE n.id = "your_entity_id" RETURN n`
- Check pipeline logs for validation failures

## Next Steps

1. **Test Basic Queries:**
   ```bash
   python query_executor_agent_test.py test
   ```

2. **Test Claim Submission:**
   ```bash
   python query_executor_agent_test.py claims
   ```

3. **Manual Exploration:**
   ```bash
   python query_executor_agent_test.py interactive
   ```

4. **Review Claim Nodes in Neo4j:**
   ```cypher
   MATCH (c:Claim) RETURN c LIMIT 10
   ```

5. **Check Promoted Claims:**
   ```cypher
   MATCH (c:Claim {promoted: true}) RETURN c
   ```

## API Reference

### ChromatogramQueryExecutor Methods

#### `__init__()`
Initializes agent, connects to Neo4j, discovers schema, creates pipeline.

#### `query(user_query: str) -> str`
Executes natural language query against graph.
- Generates Cypher using ChatGPT
- Executes against Neo4j
- Returns formatted results

#### `submit_claim(entity_id, relationship_type, target_id, confidence, label, subject_qid, retrieval_source=None, reasoning_notes=None, facet=None) -> Dict`
Submits claim to graph.
- Validates all parameters
- Creates claim with intermediary nodes
- Promotes if confidence >= 0.90
- Returns status dict

#### `close()`
Closes Neo4j connection. Call this before exiting.

#### `interactive_session()`
Starts REPL for manual query testing.

## Performance Notes

- **Schema discovery:** ~200ms (cached after first call)
- **Query generation (ChatGPT):** ~1-2s per query
- **Query execution:** Varies by query complexity
- **Claim creation:** ~500ms (includes intermediary nodes)
- **Claim promotion:** ~300ms additional (atomic Cypher transaction)

## Production Consideration

This agent is suitable for:
- Testing and validation
- Small batch claim submissions (<100 claims/minute)
- Interactive query exploration
- Prototyping agent workflows

For production use, consider:
- Adding rate limiting on ChatGPT calls
- Batch claim submission endpoint (FastAPI)
- Query result caching
- MCP server integration for Copilot access
- Error recovery and retry logic

## See Also
- [QUERY_EXECUTOR_AGENT_PROMPT.md](../../md/Agents/QUERY_EXECUTOR_AGENT_PROMPT.md) - System prompt for agent role
- [claim_ingestion_pipeline.py](../tools/claim_ingestion_pipeline.py) - Pipeline implementation
- [requirements.txt](../agents/requirements.txt) - Python dependencies
